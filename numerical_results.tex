% !TEX root = regularized.tex
The described methods have been implemented and tested using MATLAB R2020a and the toolboxes AIR Tools II \cite{art:HANS18} and IR Tools \cite{art:GAZZ19}. We stop the outer iteration when
\[
\|L x^{(\ell)}\|_2^2 < \|L x^{(\ell-1)}\|_2^2,
\]
as proposed in \cite{Gazzola_etal_2020}. The multigrid preconditioned
FGMRES iteration was used (without restarting), with a stopping
criterion of a reduction of the $\ell^2$ norm of the residual of the normal equations to below $10^{-6}$. As possible values for the regularization parameter, $\lambda$, in the outer iteration, we used 30 values equally distributed on a logarithmic scale between $10^{-3}$ and $10^{2}$ using MATLAB's \texttt{logspace(2,-3,30)} command.

\subsection{Usage of the solution of the previous iteration}
Before evaluating the proposed method in detail, we want to highlight the effect of using the solution of the previous outer (and inner) iteration at each step. Instead of choosing a zero initial guess, as would be commonly used, we use the best available approximation to the solution as the initial guess for each linear solve.  For the first inner iteration with each outer iteration, this is the solution of the previous outer iteration.  For each subsequent inner iteraiton, it is the solution of the previous inner iteration.  We use a tomography example, using the Shepp Logan phantom of different sizes with different amounts of added noise, created using IR Tools' \cite{art:GAZZ19} \texttt{PRtomo} and \texttt{PRnoise} routines. The resulting average number of inner iterations per outer iteration is plotted in Fig.~\ref{fig:zero_initial_guess_vs_previous_iteration}, demonstrating that, in general, using the available information reduces the number of inner iterations needed.  Thus, in all further experiments we use these improved initial guesses.
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/zero_initial_guess_vs_previous_iteration}
\caption{Number of inner iterations needed in each outer iteration of the method applied to the Shepp Logan phantom. Solid lines represent the average number of iterations needed when using a zero initial guess, and dashed lines represent the same number when using the solution of the previous inner (or outer) iteration.}
\label{fig:zero_initial_guess_vs_previous_iteration}
\end{center}
\end{figure}

\subsection{Effect of pre- and post-relaxation}
\label{ssec:relaxation_comparison}
An important parameter that has to be chosen in multigrid methods is the number of pre- and post-relaxation steps. To be able to do this, we study the dependence of the convergence rate on the number of pre- and post-relaxation steps. For that purpose, we study the same tomography example as before, limiting ourselves to size $128 \times 128$ with 1\% added noise. We tested V(0,1)-, V(1,1)-, V(1,2)-, V(2,1)- and V(2,2)-cycles for this problem. For each outer iteration, we recorded the minimal, maximal and average number of inner iterations needed for the different values of $\lambda$ that were evaluated in the respective outer iteration. The resulting maximal, minimal and average numbers of iterations is depicted in Fig.~\ref{fig:its_cycling}, while the average number of iterations needed in each outer iteration can also be found in Table~\ref{tab:its_cycling}. As can be seen from these results, the difference in performance between V(2,1) cycles and V(2,2) cycles is small, and the former even perform better for some early outer iterations.  On the other hand, particularly for early outer iterations, the improvement given by using V(2,1) cycles over V(1,1) or V(1,2) cycles is clear.   Therefore, we use V(2,1) cycles in the rest of our numerical experiments.
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/its_cycling}
\caption{Number of inner iterations needed in each outer iteration of the method applied to the Shepp Logan phantom of size $128 \times 128$ with 1\% noise for different multigrid cycles. Solid lines represent the average number of iterations needed for the different values of lambda, dashed lines the maximum number of iterations, and dotted lines the minimum.}
\label{fig:its_cycling}
\end{center}
\end{figure}
\begin{table}[htp]
\caption{Average number of inner iterations needed in each outer iterations of the method applied to the Shepp Logan phantom of size $128 \times 128$ with 1\% noise for different multigrid cycles.}
\begin{center}
\begin{tabular}{|l|r|r|r|r|r|r|r|r|r|r|}
\hline
& \multicolumn{1}{c|}{1} & \multicolumn{1}{c|}{2} & \multicolumn{1}{c|}{3} & \multicolumn{1}{c|}{4} & \multicolumn{1}{c|}{5} & \multicolumn{1}{c|}{6} & \multicolumn{1}{c|}{7} & \multicolumn{1}{c|}{8} & \multicolumn{1}{c|}{9} & \multicolumn{1}{c|}{10} \\
\hline
V(0,1) & 28.0 & 46.5 & 28.1 & 18.5 & 9.5 & 6.7 & 6.2 & 5.7 & 5.7 & 5.4 \\
V(1,1) & 15.0 & 18.0 & 13.0 & 8.4 & 5.6 & 5.0 & 4.4 & 4.2 & \multicolumn{1}{c|}{---} & \multicolumn{1}{c|}{---}\\
V(1,2) & 13.1 & 18.8 & 14.6 & 8.2 & 4.6 & 3.7 & 3.5 & 3.4 & \multicolumn{1}{c|}{---} & \multicolumn{1}{c|}{---} \\
V(2,1) & 8.8 & 11.9 & 7.7 & 5.1 & 3.8 & 3.8 & 3.7 & 3.7 & 3.6 & 3.6 \\
V(2,2) & 10.4 &16.3 & 11.5 & 7.6 & 3.9 & 3.1 & 3.0 & 2.9 & \multicolumn{1}{c|}{---} & \multicolumn{1}{c|}{---} \\
\hline
\end{tabular}
\end{center}
\label{tab:its_cycling}
\end{table}%


\subsection{Effect of trimming the L-curve}
\label{ssec:trimming_numerical}
Using the V(2,1)-cycle and 1\% noise, we next consider the effect of the proposed trimming of the L-curve for a computer tomography example using the Shepp Logan phantom of sizes $64 \times 64$, $128 \times 128$ and $256 \times 256$. We compare the L-curve algorithm from \cite{OlearyHansen} applied to the whole range of values of $\lambda$ with two variants that apply it to a smaller range of values. The first variant uses only the smallest 10 values of $\lambda$ when computing the solution to the first outer iteration and, after that, takes the range described above with the seven larger values of $\lambda$ than the optimal value chosen at the previous outer iteration, that value itself, and the two immediately smaller values. The second variant uses the whole range of $\lambda$ values at the first outer iteration but, from the second iteration onwards, follows the same strategy as the first variant. The regularization parameters chosen are depicted in Fig.~\ref{fig:shepp_logan_reg_params_with_and_without_trimming}. Here, we see that, for these examples, the first variant tends to choose a too small regularization parameter in the first iteration, leading to a larger number of iterations. The second variant, in contrast, choses almost exactly the same regularization parameters and shows the same algorithmic behavior as the variant without trimming, but at a little more than one third of the computational cost.
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/shepp_logan_reg_params_with_and_without_trimming}
\caption{Effect of trimming the L-curve for a full angle computer tomography using the Shepp Logan phantom with 1\% noise. Depicted are the regularization parameters chosen by the algorithm. The modified trimming uses trimming only after the first iteration.}
\label{fig:shepp_logan_reg_params_with_and_without_trimming}
\end{center}
\end{figure}

\subsection{Full angle computer tomography}
For the computer tomography example using the Shepp Logan phantom of sizes $64 \times 64$, $128 \times 128$ and $256 \times 256$, we now compare the performance of the algorithm for different noise levels. We used the modified trimming approach and a V(2,1)-cycle for preconditioning FGMRES for 0.5\% noise, 1\% noise, and 2\% noise. The resulting errors and the chosen regularization parameters can be found in Fig.~\ref{fig:shepp_logan_errs_and_reg_params} and in Table~\ref{tab:shepp_logan_errs_and_reg_params}. The minimal, maximal and average inner interations needed can be found in Fig~\ref{fig:shepp_logan_inner_its}. The initial and final reconstructions are in Fig.~\ref{fig:shepp_logan_initial_and_final}.

\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/shepp_logan_errs_and_reg_params}
\caption{Errors (left) and regularization parameters chosen (right) for full angle computer tomography of the Shepp Logan phantom for different image sizes (by row) and noise levels.}
\label{fig:shepp_logan_errs_and_reg_params}
\end{center}
\end{figure}
\begin{table}[htp]
\caption{Errors and regularization parameters chosen for the Shepp Logan computer tomography example for different image sizes and 0.5\% noise.}
\begin{center}
\begin{tabular}{|r|r|r|r|r|r|r|r|r|r|r|}
\hline
\multicolumn{1}{|c|}{outer} & \multicolumn{2}{c|}{$n = 64$} & \multicolumn{2}{c|}{$n = 128$} & \multicolumn{2}{c|}{$n = 256$} \\\cline{2-7}
\multicolumn{1}{|c|}{iter.} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$}  & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} \\
\hline
1 & 0.0291 & 0.0240 & 0.0621 & 0.0356 & 0.1495 & 0.1495 \\
2 & 0.0230 & 0.0788 & 0.0379 & 0.1172 & 0.0780 & 0.0780 \\
3 & 0.0187 & 0.1743 & -- & -- & -- & -- \\
4 & 0.0108 & 0.3857 & -- & -- & -- & -- \\
\hline
\end{tabular}
\end{center}
\label{tab:shepp_logan_errs_and_reg_params}
\end{table}%
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/shepp_logan_inner_its}
\caption{Inner iterations for full angle computer tomography of the Shepp Logan phantom.  Solid lines represent the average number of iterations needed for the different values of lambda, dashed lines the maximum number of iterations, and dotted lines the minimum.}
\label{fig:shepp_logan_inner_its}
\end{center}
\end{figure}%
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/shepp_logan_initial}\includegraphics{figures/shepp_logan_final}
\caption{Initial and final image obtained for the Shepp Logan computer tomography example for size $128 \times 128$ and 0.5\% noise.}
\label{fig:shepp_logan_initial_and_final}
\end{center}
\end{figure}%

\subsection{Limited angle computer tomography}
We now consider a similar example for \textit{limited angle} computer tomography, using the grains example from IR tools \cite{art:GAZZ19}. We use the command \texttt{PRset('angles', 0:2:130, 'phantomImage', 'grains')} to set up the problem and choose sizes $64 \times 64$, $128 \times 128$, and $256 \times 256$. As before, we compare the performance using the modified trimming and a V(2,1)-cycle for preconditioning FGMRES with 0.5\% noise, 1\% noise, and 2\% noise. Fig.~\ref{fig:limited_angle_grains_errs_and_reg_params} and Table~\ref{tab:limited_angle_grains_errs_and_reg_params} show the resulting errors and the chosen regularization parameters. The initial and final reconstructions are in Fig.~\ref{fig:limited_angle_grains_initial_and_final}.
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/limited_angle_grains_errs_and_reg_params}
\caption{Errors (left) and regularization parameters chosen (right) for the 130-degree limited angle computer tomography of the grains example for different image sizes (by row) and noise levels.}
\label{fig:limited_angle_grains_errs_and_reg_params}
\end{center}
\end{figure}
\begin{table}[htp]
\caption{Errors and regularization parameters chosen for the 130-degree limited angle computer tomography of the grains example for different image sizes and 0.5\% noise.}
\begin{center}
\begin{tabular}{|r|r|r|r|r|r|r|r|r|r|r|}
\hline
\multicolumn{1}{|c|}{outer} & \multicolumn{2}{c|}{$n = 64$} & \multicolumn{2}{c|}{$n = 128$} & \multicolumn{2}{c|}{$n = 256$} \\\cline{2-7}
\multicolumn{1}{|c|}{iter.} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$}  & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} \\
\hline
1 & 0.0734 & 0.0788 & 0.1057 & 0.1172 & 0.1199 & 0.1199 \\
2 & 0.0593 & 0.1172 & 0.0948 & 0.1743 & 0.1128 & 0.1128 \\
3 & 0.0507 & 0.2593 & -- & -- & 0.1092 & 0.1092 \\
4 & 0.0370 & 0.3857 & -- & -- & -- & -- \\
5 & 0.0305 & 0.5736 & -- & -- & -- & -- \\
6 & 0.0251 & 1.2690 & -- & -- & -- & -- \\
7 & 0.0194 & 1.8874 & -- & -- & -- & -- \\
8 & 0.0167 & 2.8072 & -- & -- & -- & -- \\
9 & 0.0143 & 4.1753 & -- & -- & -- & -- \\
10 & 0.0145 & 6.2102 & -- & -- & -- & -- \\
11 & 0.0152 & 9.2367 & -- & -- & -- & -- \\
12 & 0.0158 & 13.7382 & -- & -- & -- & -- \\
13 & 0.0169 & 20.4336 & -- & -- & -- & -- \\\hline
\end{tabular}
\end{center}
\label{tab:limited_angle_grains_errs_and_reg_params}
\end{table}%
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/limited_angle_grains_initial}\includegraphics{figures/limited_angle_grains_final}
\caption{Initial and final image obtained for the 130-degree limited angle computer tomography of the grains example for size $128 \times 128$ and 0.5\% noise.}
\label{fig:limited_angle_grains_initial_and_final}
\end{center}
\end{figure}

\subsection{Image deblurring}
To demonstrate that the methodology also works for other inverse problems, we now blur the grains example images of sizes $64 \times 64$, $128 \times 128$ and $256 \times 256$, using a discretized integral kernel for the $m \times n$ image represented by the Toeplitz matrix created using:
\begin{verbatim}

band1 = 8; sigma1=1.5*n/64; 
band2 = 7; sigma2=1.25*n/64;
z1 = [exp(-((0:band1-1).^2)/(2*sigma1^2)),zeros(1,n-band1)];
z1 = z1./(2*sum(z1)-1); z1=z1';
z2 = [exp(-((0:band2-1).^2)/(2*sigma2^2)),zeros(1,m-band2)];
z2 = z2./(2*sum(z2)-1); z2=z2';
A1 = toeplitz(z1); A1 = sparse(A1); 
A2 = toeplitz(z2); A2 = sparse(A2);
A = kron(A1,A2);

\end{verbatim}
As before, 0.5\%, 1\%, and 2\% noise are added to the blurred image and the method is applied using the same settings. The behavior of the algorithm is similar to the other cases and errors as well as regularization parameters are to be found in Fig,~\ref{fig:grains_blurring_errs_and_reg_params} and in Table~\ref{tab:grains_blurring_errs_and_reg_params}. The initial and final reconstruction are in Fig.~\ref{fig:grains_blurring_initial_and_final}.
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/grains_blurring_errs_and_reg_params}
\caption{Errors (left) and regularization parameters chosen (right) for the blurred grains example for different image sizes (by row) and noise levels.}
\label{fig:grains_blurring_errs_and_reg_params}
\end{center}
\end{figure}
\begin{table}[htp]
\caption{Errors and regularization parameters chosen for the blurred grains example for different image sizes and 0.5\% noise.}
\begin{center}
\begin{tabular}{|r|r|r|r|r|r|r|r|r|r|r|}
\hline
\multicolumn{1}{|c|}{outer} & \multicolumn{2}{c|}{$n = 64$} & \multicolumn{2}{c|}{$n = 128$} & \multicolumn{2}{c|}{$n = 256$} \\\cline{2-7}
\multicolumn{1}{|c|}{iter.} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$}  & \multicolumn{1}{c|}{$\lambda$} & \multicolumn{1}{c|}{$\frac{\|x - x^{(*,\ell)}\|_2}{\|x\|_2}$} \\
\hline
1 & 0.1051 & 0.0022 & 0.1215 & 0.0033 & 0.0928 & 0.0928 \\
2 & 0.0891 & 0.0022 & 0.1060 & 0.0049 & 0.0872 & 0.0872 \\
3 & 0.0746 & 0.0033 & 0.0920 & 0.0073 & 0.0781 & 0.0781 \\
4 & 0.0575 & 0.0049 & 0.0800 & 0.0108 & 0.0731 & 0.0731 \\
5 & 0.0486 & 0.0108 & 0.0715 & 0.0161 & 0.0648 & 0.0648 \\
6 & 0.0427 & 0.0161 & 0.0684 & 0.0240 & 0.0591 & 0.0591 \\
7 & 0.0413 & 0.0240 & 0.0677 & 0.0530 & 0.0571 & 0.0571 \\
8 & 0.0408 & 0.0530 & 0.0672 & 0.0788 & 0.0561 & 0.0561 \\
9 & 0.0406 & 0.0788 & 0.0673 & 0.1172 & 0.0566 & 0.0566 \\
10 & 0.0394 & 0.1172 & 0.0676 & 0.1743 & 0.0574 & 0.0574 \\
11 & 0.0392 & 0.2593 & 0.0680 & 0.2593 & 0.0581 & 0.0581 \\
12 & 0.0392 & 0.5736 & 0.0685 & 0.3857 & 0.0588 & 0.0588 \\
13 & 0.0391 & 1.8874 & 0.0693 & 0.5736 & 0.0592 & 0.0592 \\
14 & 0.0390 & 2.8072 & 0.0696 & 0.8532 & 0.0592 & 0.0592 \\
15 & 0.0387 & 13.7382 & 0.0698 & 1.2690 & 0.0597 & 0.0597 \\
16 & 0.0388 & 20.4336 & 0.0699 & 1.8874 & 0.0602 & 0.0602 \\
17 & -- & -- & 0.0700 & 2.8072 & 0.0609 & 0.0609 \\
18 & -- & -- & 0.0701 & 4.1753 & 0.0614 & 0.0614 \\
19 & -- & -- & 0.0702 & 13.7382 & 0.0619 & 0.0619 \\
20 & -- & -- & 0.0702 & 20.4336 & 0.0620 & 0.0620 \\
21 & -- & -- & 0.0703 & 67.2336 & 0.0622 & 0.0622 \\
22 & -- & -- & 0.0703 & 67.2336 & 0.0624 & 0.0624 \\
23 & -- & -- & -- & -- & 0.0625 & 0.0625 \\
\hline
\end{tabular}
\end{center}
\label{tab:grains_blurring_errs_and_reg_params}
\end{table}%
\begin{figure}[htbp]
\begin{center}
\includegraphics{figures/grains_blurring_initial}\includegraphics{figures/grains_blurring_final}
\caption{Initial and final image obtained for the blurred grains example for size $128 \times 128$ and 0.5\% noise.}
\label{fig:grains_blurring_initial_and_final}
\end{center}
\end{figure}

%As a first example we consider the Shepp-Logan phantom, generated by
%the MATLAB command \texttt{phantom}. We consider a version of size
%$64^2$ with added noise of level $0.5\%$, $1\%$ and $2\%$. The
%iteration was stopped, when the regularization error of the current
%solution $x^{(k)}$, measured as the 2-norm of $L^TW^2L$ applied to it,
%grew again, i.e., when
%\[
%  \| L^TW^2L x^{(k)} \|_2 > \| L^TW^2L x^{(k-1)} \|_2.
%\]
%In this case, the previous solution $x^{(k-1)}$ usually provides a
%good reconstruction.
%
%First, we ran the proposed algorithm for a full-angle Radon transform
%with 30 fixed values of $\lambda$, logarithmically spaced between
%$10^{-3}$ and $10^2$. The $\lambda$ chosen in each iteration can be
%found in Table~\ref{tab:chosen_lambda_all_lambda_full_angle}.
%
%\begin{table}
%  \begin{center}
%    \begin{tabular}{c|ccc|ccc}
%      Problem & \multicolumn{3}{|c}{full angle case} &
%                                                       \multicolumn{3}{|c}{limited
%                                                       angle case} \\
%      Noise & $0.5\%$ & $1\%$ & $2\%$ & $0.5\%$ & $1\%$ & $2\%$ \\
%      \hline
%      Iteration 1 & 0.0161 & 0.0356 & 0.0530 & 0.0161 & 0.0356 & 0.0530 \\
%      Iteration 2 & 0.0240 & 0.0530 & 0.0788 & 0.0240 & 0.0356 & 0.0788 \\
%      Iteration 3 & 0.0530 & 0.1172 & 0.2593 & 0.0356 & 0.0788 & 0.1172 \\
%      Iteration 4 & 0.0788 & 0.1743 & 0.3857 & 0.0530 & 0.1172 & 0.1743 \\
%      Iteration 5 & 0.1743 & 0.3857 & 0.8532 & 0.0788 & 0.1172 & 0.5736 \\
%      Iteration 6 & 0.3857 & 1.2690 & 1.2690 & 0.0788 & 0.1743 & 0.8532 \\
%      Iteration 7 & 1.2690 & 1.8874 & 2.8072 & 0.1172 & 0.2593 & 1.2690 \\
%      Iteration 8 & 2.8072 & 2.8072 & 6.2102 & 0.1172 & 0.5736 & 1.8874 \\
%      Iteration 9 & 6.2102 & 6.2102 & 9.2367 & 0.1743 & 0.8532 & 2.8072 \\
%      Iteration 10 & 13.7382 & 13.7382 & 13.7382 & 0.2593 & 1.2690 & 6.2102 \\
%      Iteration 11 & 30.3920 & 20.4336 & 30.3920 & 0.3857 & 1.8874 & 6.2102 \\
%      Iteration 12 & 67.2336 & 45.2035 & 67.2336 & 0.5736 & 1.8874 & 13.7382 \\
%      Iteration 13 & 67.2336 & 67.2336 & 67.2336 & 1.2690 & 2.8072 & 20.4336 \\
%      Iteration 14 & 2.8072 & 67.2336 & 67.2336 & 2.8072 & 4.1753 & 30.3920 \\
%      Iteration 15 & --- & 67.2336 & 67.2336 & 6.2102 & 6.2102 & 45.2035 \\
%      Iteration 16 & --- & 67.2336 & 6.2102 & 13.7382 & 13.7382 & 67.2336 \\
%      Iteration 17 & --- & 6.2102 & --- & 30.3920 & 30.3902 & 67.2336 \\
%      Iteration 18 & --- & --- & --- & 67.2336 & 67.2336 & 67.2336 \\
%      Iteration 19 & --- & --- & --- & 67.2336 & 67.2336 & 67.2336 \\
%      Iteration 20 & --- & --- & --- & 67.2336 & 67.2336 & 67.2336 \\
%      Iteration 21 & --- & --- & --- & 4.1753 & 4.1753 & 67.2336 \\
%      Iteration 22 & --- & --- & --- & --- & --- & 13.7382 \\
%    \end{tabular}
%  \end{center}
%  \caption{Chosen $\lambda$ in each iteration for different noise
%    levels for the full angle case.}
%  \label{tab:chosen_lambda_all_lambda_full_angle}
%\end{table}

% \subsection{Deblurring?}

% \subsection{Radon Transform}

% Current example.  Play with noise level (once L-curve selection is
% back in).

% \subsection{Another example?}

